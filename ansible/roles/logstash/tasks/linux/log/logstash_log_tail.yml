#-----------------------------------------------------------------------------------------------------------------------
# Log search
#
# Author: liza.dayoub@elastic.co
#-----------------------------------------------------------------------------------------------------------------------

---

- name: Wait for log file to be present
  wait_for: path="{{ logstash_log_file }}" timeout="{{ logstash_timeout }}"
  tags: start_logstash

- name: Wait for logstash log string
  shell: >-
    timeout "{{ logstash_timeout }}"
    sed -r '/{%- if ait_args is defined -%}
                {{ logstash_log_find[ait_args.get('ait_log_searchstr')] }}
             {%- elif ait_log_searchstr is defined -%}
                {{ logstash_log_find[ait_log_searchstr] }}
             {%- endif -%}/q' <(tail -n 0 -f "{{ logstash_log_file }}")
  args:
    executable: /bin/bash
  become: '{{ logstash_run_as_root | default(omit) }}'
  tags: logstash_log_check
