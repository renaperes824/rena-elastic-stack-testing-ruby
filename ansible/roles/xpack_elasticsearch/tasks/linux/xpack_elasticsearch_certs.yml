#-----------------------------------------------------------------------------------------------------------------------
# Elasticsearch x-pack configuration
#
# Author: liza.dayoub@elastic.co
#-----------------------------------------------------------------------------------------------------------------------

- name: Create instances.yml
  template:
    src: "{{ lookup('env','ANSIBLE_TEMPLATES') }}/instances.j2"
    dest: "{{ elasticsearch_xpack_config_dir }}/instances.yml"

- name: Run certgen
  shell: "{{ elasticsearch_certgen_exe }} -in instances.yml -out {{ elasticsearch_xpack_config_dir }}/certificate-bundle.zip"
  register: output

- name: Extract certificate package
  unarchive:
    src: "{{ elasticsearch_xpack_config_dir }}/certificate-bundle.zip"
    dest: "{{ elasticsearch_xpack_config_dir }}"
    remote_src: True

- name: Create certificate directory on localhost
  file:
    path: "{{ local_certs_dir }}"
    state: directory
  delegate_to: localhost

- name: Fetch certificates, store on localhost
  fetch:
    src: "{{ elasticsearch_xpack_config_dir }}/certificate-bundle.zip"
    dest: "{{ local_certs_dir }}/certificate-bundle.zip"
    flat: yes

- name: Extract certificate package on localhost
  unarchive:
    src: "{{ local_certs_dir }}/certificate-bundle.zip"
    dest: "{{ local_certs_dir }}"
    remote_src: True
  delegate_to: localhost
